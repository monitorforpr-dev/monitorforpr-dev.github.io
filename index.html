<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Google Sheets)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  body { font-family: "Segoe UI", Tahoma, sans-serif; background: #f7fbff; padding: 20px; }
  h1 { color: #0b3a80; margin: 0 0 12px 0; font-size: 22px; }
  h2 { color: #0e4da4; margin: 12px 0 8px; font-size: 16px; }
  .section { background: #fff; border: 1px solid #e3efff; border-radius: 12px; padding: 12px; margin-top: 12px; }
  .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
  input[type="text"], select { padding: 8px; border-radius: 8px; border: 1px solid #c6dafc; }
  .btn { background:#0b66ff; color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; font-size:13px; }
  .btn:hover { filter: brightness(.96); }
  table { border-collapse: collapse; width: 100%; background: white; border-radius: 8px; overflow: hidden; }
  th, td { padding: 10px; border-bottom: 1px solid #e3efff; font-size: 14px; }
  th { background: #e8f2ff; color: #0b3a80; text-align:left; }
  tr:hover { background-color: #f0f8ff; }
  .th-right { text-align:right; }
  .status-badge { display:inline-block; border-radius:8px; padding:4px 8px; font-weight:700; }
  .bg-green { background:#3FBF7F; color:#073b2f; }    /* ‡∏ú‡∏π‡∏Å PO ‡πÅ‡∏•‡πâ‡∏ß */
  .bg-orange { background:#FFA94D; color:#5a2d00; }   /* ‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß / ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤ */
  .bg-default { background:#E8F2FF; color:#123d7e; }  /* ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ */
  .error { background:#fff1f0; color:#a8071a; border:1px solid #ffccc7; padding:8px 10px; border-radius:8px; margin-bottom:8px; display:none; }

  .summary { display:flex; gap:12px; flex-wrap:wrap; }
  .card { background:#f9fbff; border:1px solid #d7e6ff; border-radius:12px; padding:10px 12px; min-width:220px; }
  .label { font-size:12px; color:#3b5aa8; }
  .value { font-size:20px; font-weight:700; color:#0b3a80; }
</style>
</head>
<body>
  <h1>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Google Sheets)</h1>

  <div id="errBox" class="error">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>

  <div class="section">
    <div class="controls">
      <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</label>
      <select id="unitFilter"><option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</option></select>
      <input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ ...">
      <button class="btn" id="btnRefresh">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
      <span style="font-size:12px;color:#2b5ea8;">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å <span id="refreshSec">60</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</span>
    </div>
    <table id="tbl">
      <thead>
        <tr>
          <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
          <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£)</th>
          <th class="th-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
          <th>‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô</th>
          <th>‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</th>
          <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <div class="summary">
      <div class="card">
        <div class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</div>
        <div class="value" id="sumCount">0</div>
      </div>
      <div class="card">
        <div class="label">‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</div>
        <div class="value" id="sumAmount">0</div>
      </div>
    </div>
    <h2 style="margin-top:10px;">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</h2>
    <table style="width:100%;border-collapse:collapse;">
      <thead><tr><th>‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô</th><th class="th-right">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</th></tr></thead>
      <tbody id="fundBreakdown"></tbody>
    </table>
  </div>

  <!-- Modal -->
  <div id="modal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35)">
    <div style="background:white; width:min(640px,92vw); border-radius:12px; border:1px solid #e3efff;">
      <div id="modalTitle" style="padding:12px 16px; border-bottom:1px solid #e9f1ff; font-weight:700; color:#0e4da4;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</div>
      <div id="modalBody" style="padding:14px; color:#0f2b54; white-space:pre-wrap;">‚Äî</div>
      <div style="padding:10px 16px; border-top:1px solid #e9f1ff; text-align:right;">
        <button id="closeModal" class="btn">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

<script>
/* ===== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤: ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ä‡∏µ‡∏ï + ‡∏£‡∏≠‡∏ö‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä ===== */
const GSHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS9NHoIRNnKcsdn3IUyYtYc1SWc6zcLG3vjrct_TK71RMRfkS7HVng1C95IdxzLDA/pub?gid=476370469&single=true&output=csv";
const REFRESH_SECONDS = 60;

/* ===== Utilities ===== */
function parseCSV(text) {
  const rows = [];
  let i=0, field="", row=[], inQuotes=false;
  while (i<text.length) {
    const c=text[i];
    if (inQuotes) {
      if (c === '"') { if (text[i+1] === '"') { field+='"'; i++; } else { inQuotes=false; } }
      else { field += c; }
    } else {
      if (c === '"') inQuotes = true;
      else if (c === ',') { row.push(field); field=""; }
      else if (c === '\n') { row.push(field); rows.push(row); row=[]; field=""; }
      else if (c !== '\r') field += c;
    }
    i++;
  }
  row.push(field); rows.push(row);
  while (rows.length && rows[rows.length-1].length===1 && rows[rows.length-1][0]==="") rows.pop();
  return rows;
}
function norm(s){ return (s||"").toString().replace(/\s+/g,"").toLowerCase(); }
function escapeHtml(s) { return (s||"").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
function fmtAmount(x) { const n = Number((x||"").toString().replace(/,/g,"").trim()); return isNaN(n) ? "" : n.toLocaleString('th-TH', { maximumFractionDigits: 0 }); }
function parseAmount(x){ const n = Number((x||"").toString().replace(/,/g,"").trim()); return isNaN(n) ? 0 : n; }
function statusClass(s){ s=(s||"").trim(); if(s==="‡∏ú‡∏π‡∏Å PO ‡πÅ‡∏•‡πâ‡∏ß") return "bg-green"; if(s==="‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß"||s==="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤") return "bg-orange"; return "bg-default"; }

/* ===== Header mapping ‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô ===== */
function autoMap(headers){
  function find(cands){
    for (const c of cands){
      const idx = headers.findIndex(h => norm(h)===norm(c));
      if (idx>=0) return idx;
    }
    return -1;
  }
  return {
    unit:   find(["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô","‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô/‡∏ù‡πà‡∏≤‡∏¢","‡∏ù‡πà‡∏≤‡∏¢","‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]),
    name:   find(["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£","‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£","‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£(‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£)","‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£"]),
    amount: find(["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô","‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô","‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì","‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô(‡∏ö‡∏≤‡∏ó)","‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô"]),
    fund:   find(["‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô","‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏à‡∏≤‡∏Å","‡∏á‡∏ö","‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì/‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô"]),
    status: find(["‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô","‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞","‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô","‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"]),
    note:   find(["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏","‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞","‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î","‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"])
  };
}

/* ===== Global State ===== */
let HEADER=[], ROWS=[], MAP=null;

/* ===== Filtering/Rendering ===== */
function fillUnitFilter() {
  const sel = document.getElementById("unitFilter");
  sel.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</option>';
  if (MAP.unit>=0) {
    const units = Array.from(new Set(ROWS.map(r => r[MAP.unit]||"").filter(Boolean))).sort();
    units.forEach(u => { const opt=document.createElement("option"); opt.value=u; opt.textContent=u; sel.appendChild(opt); });
  }
}

function applyFilters() {
  const unitSel = document.getElementById("unitFilter").value.trim().toLowerCase();
  const q = document.getElementById("searchInput").value.trim().toLowerCase();
  return ROWS.filter(r => {
    const unit = (MAP.unit>=0 ? (r[MAP.unit]||"") : "").toLowerCase();
    const name = (MAP.name>=0 ? (r[MAP.name]||"") : "");
    const fund = (MAP.fund>=0 ? (r[MAP.fund]||"") : "");
    const status = (MAP.status>=0 ? (r[MAP.status]||"") : "");
    const note = (MAP.note>=0 ? (r[MAP.note]||"") : "");
    if (unitSel && unit !== unitSel) return false;
    if (q) {
      const hay = (unit + " " + name + " " + fund + " " + status + " " + note).toLowerCase();
      if (hay.indexOf(q) === -1) return false;
    }
    return true;
  });
}

function renderSummary(filtered){
  let total=0;
  filtered.forEach(r => { if (MAP.amount>=0) total += parseAmount(r[MAP.amount]); });
  document.getElementById("sumCount").textContent = filtered.length;
  document.getElementById("sumAmount").textContent = fmtAmount(total);

  const body = document.getElementById("fundBreakdown");
  body.innerHTML = "";
  const acc = {};
  filtered.forEach(r => {
    const fund = (MAP.fund>=0 ? (r[MAP.fund]||"") : "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏") || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
    const amt = (MAP.amount>=0 ? parseAmount(r[MAP.amount]) : 0);
    acc[fund] = (acc[fund]||0) + amt;
  });
  Object.keys(acc).sort((a,b)=>acc[b]-acc[a]).forEach(k => {
    const tr=document.createElement("tr");
    const td1=document.createElement("td"); td1.textContent=k;
    const td2=document.createElement("td"); td2.style.textAlign="right"; td2.textContent=fmtAmount(acc[k]);
    tr.appendChild(td1); tr.appendChild(td2); body.appendChild(tr);
  });
}

function renderTable(){
  const tbody = document.querySelector("#tbl tbody");
  tbody.innerHTML = "";
  const filtered = applyFilters();
  renderSummary(filtered);

  filtered.forEach(r => {
    const unit   = MAP.unit>=0 ? (r[MAP.unit]||"") : "";
    const name   = MAP.name>=0 ? (r[MAP.name]||"") : "";
    const amount = MAP.amount>=0 ? (r[MAP.amount]||"") : "";
    const fund   = MAP.fund>=0 ? (r[MAP.fund]||"") : "";
    const status = MAP.status>=0 ? (r[MAP.status]||"") : "";
    const note   = MAP.note>=0 ? (r[MAP.note]||"") : "";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(unit)}</td>
      <td>${escapeHtml(name)}</td>
      <td class="th-right">${fmtAmount(amount)}</td>
      <td>${escapeHtml(fund)}</td>
      <td><span class="status-badge ${statusClass(status)}">${escapeHtml(status)}</span></td>
      <td><button class="btn btn-sm">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></td>
    `;
    tr.querySelector("button").addEventListener("click", () => openNote(name, note));
    tr.querySelector(".status-badge").addEventListener("click", () => openNote(name, note));
    tbody.appendChild(tr);
  });
}

/* ===== Modal ===== */
function openNote(title, text){
  document.getElementById("modalTitle").textContent = "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ‚Äî " + (title || "");
  document.getElementById("modalBody").textContent  = text || "‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ ‚Äî";
  document.getElementById("modal").style.display = "flex";
}

/* ===== Fetch & Auto-Refresh ===== */
async function fetchAndRender(){
  const err = document.getElementById("errBox");
  err.style.display = "none";
  try {
    const url = GSHEET_CSV_URL + (GSHEET_CSV_URL.includes("?") ? "&" : "?") + "_ts=" + Date.now(); // ‡∏Å‡∏±‡∏ô‡πÅ‡∏Ñ‡∏ä
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();
    const grid = parseCSV(text);
    if (!grid.length) throw new Error("CSV ‡∏ß‡πà‡∏≤‡∏á");

    HEADER = grid[0].map(h => (h||"").trim());
    ROWS   = grid.slice(1).filter(r => r.some(x => (x||"").toString().trim()!==""));
    MAP    = autoMap(HEADER);

    if (MAP.name<0 || MAP.amount<0 || MAP.status<0) {
      err.textContent = "‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏ö‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô) ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á";
      err.style.display = "block";
    }

    fillUnitFilter();
    renderTable();
  } catch(e){
    err.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: " + e.message;
    err.style.display = "block";
  }
}

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("refreshSec").textContent = REFRESH_SECONDS;
  document.getElementById("btnRefresh").addEventListener("click", fetchAndRender);
  document.getElementById("unitFilter").addEventListener("change", renderTable);
  document.getElementById("searchInput").addEventListener("input", renderTable);

  const m = document.getElementById("modal");
  document.getElementById("closeModal").addEventListener("click", () => m.style.display = "none");
  m.addEventListener("click", (e) => { if (e.target.id === "modal") m.style.display = "none"; });

  fetchAndRender();
  setInterval(fetchAndRender, REFRESH_SECONDS * 1000);
});
</script>
</body>
</html>
